#!/bin/sh

. ./shpy

testWithNoArguments_ShouldReturnUsage() {
    local output

    output=$(createSpy)

    assertFalse 'returns error' $?
    printf '%s\n' "$output" | grep -q '^Usage:'
    assertTrue 'begins with "Usage:"' $?
}

testWithOneArgument_ShouldCreateFunction() {
    createSpy dosomething || fail 'createSpy dosomething'

    type -t dosomething | grep -q function
    assertTrue 'dosomething is a function' $?
}

testShouldStubReturnValue() {
    val=123 createSpy dosomething || fail 'createSpy dosomething'

    dosomething

    assertEquals 'return value equals passed val' 123 $?
}

testShouldStubReturnValue_PerSpy() {
    val=123 createSpy dosomething || fail 'val=123 createSpy dosomething'
    val=234 createSpy domore || fail 'val=234 createSpy domore'

    dosomething
    assertEquals 'dosomething return value is 123' 123 $?
    domore
    assertEquals 'domore return value is 234' 234 $?
}

testShouldResetStubReturnValue() {
    val=123 createSpy dosomething || fail 'val=123 createSpy dosomething'
    unset val   # required for dash

    createSpy dosomething

    dosomething
    assertTrue 'dosomething returns the default -- success' $?
}

testShouldStubOutput() {
    local output
    output='some
output' \
        createSpy dosomething || fail 'createSpy dosomething'

    output=$(dosomething)

    assertTrue '`dosomething` succeeds' $?
    assertEquals 'output is the passed value' 'some
output' "$output"
}

testShouldResetStubOutput() {
    local output
    output='some output' \
        createSpy dosomething || fail 'createSpy dosomething'

    output=$(createSpy dosomething)

    assertTrue '`createSpy dosomething` succeeds' $?
    assertNull 'output is unset' "$output"
}

testShouldResetCallCount() {
    createSpy dosomething || fail 'createSpy dosomething'
    dosomething

    createSpy dosomething

    assertTrue '`createSpy dosomething` succeeds' $?
    assertEquals 0 "$(getSpyCallCount dosomething)"
}

oneTimeTearDown() {
    cleanupSpies
}

. shunit2
